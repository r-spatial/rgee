<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to integrate Rmarkdown and rgee • rgee</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to integrate Rmarkdown and rgee">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rgee</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>

  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book"></span>

    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rgee01.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rgee02.html">Consideration</a>
    </li>
    <li>
      <a href="../articles/rgee03.html">Best Practices</a>
    </li>
    <li>
      <a href="../articles/rgee04.html">Shiny apps deployment</a>
    </li>
    <li>
      <a href="../articles/rgee05.html">rgee and GCS sync</a>
    </li>
    <li>
      <a href="../articles/rgee06.html">Integrate Rmarkdown and rgee</a>
    </li>
    <li>
      <a href="https://r-earthengine.github.io/" class="external-link">rgee examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>

    news
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>

    functions
  </a>
</li>
<li>
  <a href="https://github.com/r-spatial/rgee/" class="external-link">
    <span class="fa fa-github fa-lg"></span>

    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to integrate Rmarkdown and rgee</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/rgee/blob/master/vignettes/rgee06.Rmd" class="external-link"><code>vignettes/rgee06.Rmd</code></a></small>
      <div class="hidden name"><code>rgee06.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="the-problem">
<strong>1. The problem</strong><a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>GEE offers on-the-fly computation for rendering EE spatial
objects:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/" class="external-link">rgee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rgeeExtra</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">img</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Image</span><span class="op">$</span><span class="va">Dataset</span><span class="op">$</span><span class="va">CGIAR_SRTM90_V4</span></span>
<span><span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<br><center>
<img src="images%2Fr6_01.png">
</center>
<p><br></p>
<p>However, this interactive map service <strong>is temporary</strong>,
disappearing after a short period of time (~ 4 hours). This makes
<code>Map$addLayer</code> unusable for report generation. In this
vignette, we will learn to create a <strong>permanent interactive
map</strong>.</p>
</div>
<div class="section level2">
<h2 id="a-tentative-workaround">
<strong>2. A tentative workaround</strong><a class="anchor" aria-label="anchor" href="#a-tentative-workaround"></a>
</h2>
<p>Instead of using GEE API for creating interactive maps, we will use
<a href="https://github.com/developmentseed/titiler" class="external-link"><strong>titiler</strong></a>.
titiler creates web map tiles dynamically based on COG (STAC) resources.
Since an exported EE task to retrieve images can return a COG, we just
have to move these results to a <strong>storage web service with <a href="https://www.cogeo.org/" class="external-link">HTTP GET range requests</a></strong>.</p>
<br><center>
<img src="images%2Fr6_02.png">
</center>
<p><br></p>
<p>Fortunately, <a href="https://cloud.google.com/storage/docs/json_api/v1/objects/get" class="external-link">GCS
counts with this feature</a>, so if we manage to move our results to
GCS, the work would be already done :)</p>
<pre><code>GET /OBJECT_NAME HTTP/1.1
Host: BUCKET_NAME.storage.googleapis.com
Content-Length: 0
Authorization: AUTHENTICATION_STRING
Range: bytes=BYTE_RANGE
If-Match: ENTITY_TAG
If-Modified-Since: DATE
If-None-Match: ENTITY_TAG
If-Unmodified-Since: DATE</code></pre>
</div>
<div class="section level2">
<h2 id="show-me-the-code">3. Show me the code!<a class="anchor" aria-label="anchor" href="#show-me-the-code"></a>
</h2>
<p>First, load <code>rgee</code> and <code>googleCloudStorageR</code>
and initialize the EE API. You must have correctly configured a service
account key, if not check our tutorial “<a href="https://r-spatial.github.io/rgee/articles/rgee05.html"><strong>how
to integrate Google Cloud Storage and rgee</strong></a>”.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/" class="external-link">rgee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/" class="external-link">googleCloudStorageR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Init the EE API</span></span>
<span><span class="fu"><a href="../reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span><span class="st">"csaybar"</span>, gcs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Validate your SaK</span></span>
<span><span class="co"># ee_utils_sak_validate(bucket = "rgee_examples")</span></span></code></pre></div>
<p>Define your study area.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define an study area</span></span>
<span><span class="va">EE_geom</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Point</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">70.06240</span>, <span class="op">-</span><span class="fl">6.52077</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">buffer</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<p>Select an <code>ee$Image</code>, for instance, a Landsat-8 image.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l8img</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="va">Dataset</span><span class="op">$</span><span class="va">LANDSAT_LC08_C02_T2_L2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterDate</span><span class="op">(</span><span class="st">'2021-06-01'</span>, <span class="st">'2021-12-01'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">filterBounds</span><span class="op">(</span><span class="va">EE_geom</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ee</span><span class="op">$</span><span class="va">ImageCollection</span><span class="op">$</span><span class="fu">first</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Move <code>l8img</code> from EE to GCS.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gcs_l8_name</span>  <span class="op">&lt;-</span> <span class="st">"l8demo2"</span> <span class="co"># name of the image in GCS.</span></span>
<span><span class="va">BUCKET_NAME</span> <span class="op">&lt;-</span> <span class="st">"rgee_examples"</span> <span class="co"># set here your bucket name</span></span>
<span><span class="va">task</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ee_image_to_gcs.html">ee_image_to_gcs</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">l8img</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SR_B%s"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  region <span class="op">=</span> <span class="va">EE_geom</span>,</span>
<span>  fileNamePrefix <span class="op">=</span> <span class="va">gcs_l8_name</span>,</span>
<span>  timePrefix <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  bucket <span class="op">=</span> <span class="va">BUCKET_NAME</span>,</span>
<span>  scale <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  formatOptions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cloudOptimized <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Return a COG rather than a TIFF file.</span></span>
<span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ee_monitoring.html">ee_monitoring</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Titiler needs resources downloadable for anyone. Therefore,
<strong>we recommend you to work with GCS buckets with fine-grained
access</strong>. In this way, you can decide individually which objects
to make public. On the other hand, if you decide to work with buckets
with uniform access, you will have to expose the entire bucket!. The
code below makes a specific object in your bucket <strong>public to
internet</strong>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make PUBLIC the GCS object </span></span>
<span><span class="fu">googleCloudStorageR</span><span class="fu">::</span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_update_object_acl.html" class="external-link">gcs_update_object_acl</a></span><span class="op">(</span></span>
<span>  object_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">gcs_l8_name</span>, <span class="st">".tif"</span><span class="op">)</span>,</span>
<span>  bucket <span class="op">=</span> <span class="va">BUCKET_NAME</span>,</span>
<span>  entity_type <span class="op">=</span> <span class="st">"allUsers"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, use <code>Map$addLayer</code> to display the COG resource.
By default, <code>Map$addLayer</code> use the open endpoint: <a href="https://api.cogeo.xyz/docs" class="external-link uri">https://api.cogeo.xyz/docs</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">img_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"https://storage.googleapis.com/%s/%s.tif"</span>, <span class="va">BUCKET_NAME</span>, <span class="va">gcs_l8_name</span><span class="op">)</span></span>
<span><span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bands<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SR_B4"</span>,<span class="st">"SR_B3"</span>,<span class="st">"SR_B2"</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">8000</span>, max <span class="op">=</span> <span class="fl">20000</span>, nodata <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">Map</span><span class="op">$</span><span class="fu">centerObject</span><span class="op">(</span><span class="va">img_id</span><span class="op">)</span></span>
<span><span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span></span>
<span>  eeObject <span class="op">=</span> <span class="va">img_id</span>, </span>
<span>  visParams <span class="op">=</span> <span class="va">visParams</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"My_first_COG"</span>,</span>
<span>  titiler_server <span class="op">=</span> <span class="st">"https://api.cogeo.xyz/"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If you prefer to use <a href="https://api.cogeo.xyz/docs" class="external-link">titiler
syntax</a>, set the parameter <code>titiler_viz_convert</code> as
FALSE.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>expression <span class="op">=</span> <span class="st">"B4,B3,B2"</span>, rescale <span class="op">=</span> <span class="st">"8000, 20000"</span>, resampling_method <span class="op">=</span> <span class="st">"cubic"</span><span class="op">)</span></span>
<span><span class="va">Map</span><span class="op">$</span><span class="fu">addLayer</span><span class="op">(</span></span>
<span>  eeObject <span class="op">=</span> <span class="va">img_id</span>, </span>
<span>  visParams <span class="op">=</span> <span class="va">visParams</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"My_first_COG"</span>,</span>
<span>  titiler_server <span class="op">=</span> <span class="st">"https://api.cogeo.xyz/"</span>,</span>
<span>  titiler_viz_convert <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Cesar Aybar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
