<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Integrate Google Cloud Storage and rgee • rgee</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Integrate Google Cloud Storage and rgee">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rgee</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>

  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-book"></span>

    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rgee01.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rgee02.html">Consideration</a>
    </li>
    <li>
      <a href="../articles/rgee03.html">Best Practices</a>
    </li>
    <li>
      <a href="../articles/rgee04.html">Shiny apps deployment</a>
    </li>
    <li>
      <a href="../articles/rgee05.html">rgee and GCS sync</a>
    </li>
    <li>
      <a href="../articles/rgee06.html">Integrate Rmarkdown and rgee</a>
    </li>
    <li>
      <a href="https://r-earthengine.github.io/" class="external-link">rgee examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>

    news
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>

    functions
  </a>
</li>
<li>
  <a href="https://github.com/r-spatial/rgee/" class="external-link">
    <span class="fa fa-github fa-lg"></span>

    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Integrate Google Cloud Storage and rgee</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/rgee/blob/master/vignettes/rgee05.Rmd" class="external-link"><code>vignettes/rgee05.Rmd</code></a></small>
      <div class="hidden name"><code>rgee05.Rmd</code></div>

    </div>

    
    
<p><em>Google Cloud Platform may slightly change its website. If this
occurs, help us by informing at <a href="https://github.com/r-spatial/rgee/issues/new" class="external-link">rgee issues</a>.
Based on <a href="https://bookdown.org/hegghammer/interacting_with_google_storage_in_r/interacting_with_google_storage.html" class="external-link">Interacting
with Google Storage in R</a> by <a href="https://github.com/Hegghammer" class="external-link">Thomas Hegghammer</a>.</em></p>
<p>This tutorial explains how to integrate rgee and Google Cloud Storage
(GCS) step by step. In rgee, GCS is used as an <strong>intermediary
container</strong> for massive downloading/uploading of files which is
more flexible than Google Drive. At today’s date (December 2021), GCS is
free for <a href="https://cloud.google.com/artifact-registry/pricing" class="external-link">uses of less
than 0.5 GB</a>.</p>
<p><img src="images%2Fr5_01.png"></p>
<div class="section level2">
<h2 id="create-a-service-account-key">
<strong>Create a Service Account Key</strong><a class="anchor" aria-label="anchor" href="#create-a-service-account-key"></a>
</h2>
<p>The bulk of GCS &amp; rgee sync issues is related to the creation of
a <a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" class="external-link">service
accounts key (SaK)</a> with not enough privileges for writing/reading in
GCS buckets. In order to create, configure and locally store your SaK,
perform as follow:</p>
<div class="section level4">
<h4 id="create-a-google-cloud-platform-gcp-account">
<strong>1. Create a Google Cloud Platform (GCP)
account</strong><a class="anchor" aria-label="anchor" href="#create-a-google-cloud-platform-gcp-account"></a>
</h4>
<p>Go to <a href="https://cloud.google.com/" class="external-link uri">https://cloud.google.com/</a>, and create an account. You
will have to add your address and a credit card.</p>
<br><center>
<img src="images%2Fr5_02.png">
</center>
<p><br></p>
</div>
<div class="section level4">
<h4 id="create-a-new-project">
<strong>2. Create a new project</strong><a class="anchor" aria-label="anchor" href="#create-a-new-project"></a>
</h4>
<p>Go to console.</p>
<br><center>
<img src="images%2Fr5_03.png">
</center>
<p><br></p>
<p>If it is your first time using GCP, you are assigned a project named
<strong><em>My first project</em></strong>. If you want to create a new
project (<strong>OPTIONAL</strong>). First, click on ‘My first project’
in the top blue bar, just to the right of ‘Google Cloud Platform’, and
then ‘<strong>NEW PROJECT</strong>’.</p>
<br><center>
<img src="images%2Fr5_04.png">
</center>
<p><br></p>
<p>Create a project with the desired name.</p>
<center>
<img src="images%2Fr5_05.png">
</center>
</div>
<div class="section level4">
<h4 id="activate-gcs-api">
<strong>3. Activate GCS API</strong><a class="anchor" aria-label="anchor" href="#activate-gcs-api"></a>
</h4>
<p>By default, the GCS API is activated. Make sure of it by typing
“Cloud Storage API” in the search browser.</p>
<br><center>
<img src="images%2Fr5_06.png">
</center>
<p><br></p>
<p>Click on ‘Enable APIs and Services’ (if the API is turned off). A
green checkmark as the image below means that the API is activated!</p>
<br><center>
<img src="images%2Fr5_07.png">
</center>
<p><br></p>
</div>
<div class="section level4">
<h4 id="set-up-a-service-account">
<strong>4: Set up a service account</strong><a class="anchor" aria-label="anchor" href="#set-up-a-service-account"></a>
</h4>
<p>Now we are going to create a <a href="https://cloud.google.com/iam/docs/service-accounts" class="external-link"><strong>service
account</strong></a>. A service account is used to ‘sign in’
applications that require one or many GCP services. In our case,
<strong>rgee</strong> (the app) needs an account with <strong>GCS admin
privileges</strong>. To create a service account, search for ‘Cloud
Storage’ in the browser, and click on ‘Cloud Storage’ product.</p>
<br><center>
<img src="images%2Fr5_08.png">
</center>
<p><br></p>
<p>Click on ‘settings’.</p>
<br><center>
<img src="images%2Fr5_09.png">
</center>
<p><br></p>
<p>Click on ‘INTEROPERABILITY’, and then click on ‘CREATE A KEY FOR A
SERVICE ACCOUNT’.</p>
<br><center>
<img src="images%2Fr5_10.png">
</center>
<p><br></p>
<p>Click on ‘CREATE NEW ACCOUNT’.</p>
<br><center>
<img src="images%2Fr5_11.png">
</center>
<p><br></p>
<p>Set a name (1), and define <strong>Storage Admin</strong>
(<strong>DON’T FORGET THIS STEP!!</strong>) in role (3).</p>
<br><center>
<img src="images%2Fr5_12.png">
</center>
<p><br></p>
</div>
<div class="section level4">
<h4 id="create-and-download-a-sak-as-a-json-file-">
<strong>5: Create and download a SaK as a json file.</strong><a class="anchor" aria-label="anchor" href="#create-and-download-a-sak-as-a-json-file-"></a>
</h4>
<p>Once create the service account, we have to download the
<strong>S</strong>ervice <strong>a</strong>ccount <strong>K</strong>ey
to use GCS outside the Google Cloud Platform console. A SaK is just a
JSON file with your public/private RSA keys. First, click the small edit
icon on the bottom right (three horizontal lines). Then, go to API &amp;
Services and click on <strong>credentials</strong>.</p>
<br><center>
<img src="images%2Fr5_13.png">
</center>
<p><br></p>
<p>On the next page, click on the service account name.</p>
<br><center>
<img src="images%2Fr5_14.png">
</center>
click on ‘KEYS’, ‘ADD KEY’, and ‘Create new key’.
<center>
<img src="images%2Fr5_15.png">
</center>
<p><br> Then, select JSON format, and click ‘create’. <br></p>
<center>
<img src="images%2Fr5_16.png">
</center>
<p><br></p>
<p>This should prompt a save file window. Save the file to your hard
drive. You can change the name to something more memorable if you like
(<strong>but keep the “.json” extension</strong>). Also, please take
note of where you stored it. Now we are done in the Google Cloud Console
and can finally start working in RStudio.</p>
</div>
</div>
<div class="section level2">
<h2 id="copy-the-sak-in-your-system">
<strong>Copy the SaK in your system</strong><a class="anchor" aria-label="anchor" href="#copy-the-sak-in-your-system"></a>
</h2>
<p>From rgee v.1.2.9000 we added <a href="https://r-spatial.github.io/rgee/reference/ee_utils_sak_copy.html">ee_utils_sak_copy</a>
and <a href="https://r-spatial.github.io/rgee/reference/ee_utils_sak_validate.html">ee_utils_sak_validate</a>
to help you to validate and store your SaK. Please run as follow to
properly set your SaK in your system.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remotes::install_github("r-spatial/rgee") Install rgee v.1.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/" class="external-link">rgee</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span><span class="st">"csaybar"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">SaK_file</span> <span class="op">&lt;-</span> <span class="st">"/home/csaybar/Downloads/SaK_rgee.json"</span> <span class="co"># PUT HERE THE FULLNAME OF YOUR SAK.</span></span>
<span></span>
<span><span class="co"># Assign the SaK to a EE user.</span></span>
<span><span class="fu"><a href="../reference/ee_utils_sak_copy.html">ee_utils_sak_copy</a></span><span class="op">(</span></span>
<span>  sakfile <span class="op">=</span>  <span class="va">SaK_file</span>,</span>
<span>  users <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"csaybar"</span>, <span class="st">"ryali93"</span><span class="op">)</span> <span class="co"># Unlike GD, we can use the same SaK for multiple users.</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Validate your SaK</span></span>
<span><span class="fu"><a href="../reference/ee_utils_sak_validate.html">ee_utils_sak_validate</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code>ee_utils_sak_validate</code> evaluate if <strong>rgee</strong>
with your SaK can: (1) create buckets, (2) write objects, (3) read
objects, and (4) connect GEE and GCS. If it does not retrieve an error,
<code>ee_Initialize(..., gcs = TRUE)</code> will work like a charm!. The
next step is create your own <strong>GCS bucket</strong>. Consider that
the bucket name you set must be <strong>globally unique</strong>. In
other words, two buckets can not exist with the same name in Google
Cloud Storage.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/" class="external-link">rgee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/" class="external-link">googleCloudStorageR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span><span class="st">"csaybar"</span>, gcs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create your own container</span></span>
<span><span class="va">project_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ee_get_earthengine_path.html">ee_get_earthengine_path</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"\\.json$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/read_json.html" class="external-link">read_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="st">'$'</span><span class="op">(</span><span class="va">project_id</span><span class="op">)</span> <span class="co"># Get the Project ID</span></span>
<span></span>
<span><span class="fu">googleCloudStorageR</span><span class="fu">::</span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_create_bucket.html" class="external-link">gcs_create_bucket</a></span><span class="op">(</span><span class="st">"CHOOSE_A_BUCKET_NAME"</span>, projectId <span class="op">=</span> <span class="va">project_id</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="error-cannot-insert-legacy-acl-for-an-object-when-uniform-bucket-level-access-is-enabled">
<strong>ERROR: Cannot insert legacy ACL for an object when uniform
bucket-level access is enabled</strong><a class="anchor" aria-label="anchor" href="#error-cannot-insert-legacy-acl-for-an-object-when-uniform-bucket-level-access-is-enabled"></a>
</h2>
<p>This is a <a href="https://github.com/cloudyr/googleCloudStorageR/issues/111" class="external-link">common
issue</a> related to the control access of buckets. GCS offers two
systems for granting users permission to access your buckets and
objects: <a href="https://cloud.google.com/storage/docs/access-control/iam" class="external-link">IAM</a>
(recommended, used in all Google Cloud services) and <a href="https://cloud.google.com/storage/docs/access-control/lists" class="external-link">Access
Control Lists (ACL)</a> (legacy access control system, only available in
GCS).</p>
<p>If you use the Google Cloud Platform console to create a bucket, it
will use <strong>Uniform access</strong> (<strong>IAM is used alone to
manage permissions</strong>) by default.</p>
<br><center>
<img src="images%2Fr5_17.png">
</center>
<center>
<img src="images%2Fr5_18.png">
</center>
<p><br></p>
<p>On the contrary if you use <a href="https://code.markedmondson.me/googleCloudStorageR/reference/gcs_create_bucket.html" class="external-link"><code>googleCloudStorageR::gcs_create_bucket</code></a>,
it will use fine-grained access (<strong>IAM and ACLs to manage
permissions</strong>).</p>
<br><center>
<img src="images%2Fr5_19.png">
</center>
<p><br></p>
<p>Why is this important?. It is important, because if you create a
bucket using the first option an error message will arise:
<strong>“Cannot insert legacy ACL for an object when uniform
bucket-level access is enabled. Read more at <a href="https://cloud.google.com/storage/docs/uniform-bucket-level-access" class="external-link uri">https://cloud.google.com/storage/docs/uniform-bucket-level-access</a>”</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bad --------------------------------------------------</span></span>
<span><span class="fu">googleCloudStorageR</span><span class="fu">::</span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html" class="external-link">gcs_upload</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="va">demo_data</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"demo_data.csv"</span>,</span>
<span>  bucket <span class="op">=</span> <span class="st">"demo_0002"</span> <span class="co"># Bucket with uniform control access</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#  Error: Insert legacy ACL for an object when uniform bucket-level access</span></span>
<span><span class="co">#  is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access</span></span>
<span></span>
<span></span>
<span><span class="co"># Good -------------------------------------------------</span></span>
<span><span class="fu">googleCloudStorageR</span><span class="fu">::</span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html" class="external-link">gcs_upload</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="va">demo_data</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"demo_data.csv"</span>,</span>
<span>  bucket <span class="op">=</span> <span class="st">"demo_0002"</span>, <span class="co"># Bucket with uniform control access</span></span>
<span>  predefinedAcl <span class="op">=</span> <span class="st">"bucketLevel"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>It happens due that <code>googleCloudStorageaR</code> by default
expects buckets created with fine-grained access (ACL support, see <a href="https://github.com/cloudyr/googleCloudStorageR/issues/111" class="external-link">cloudyr/googleCloudStorageR#111</a>).
To avoid this issue, from rgee v.1.3 we opt to change the default
predefinedAcl argument from ‘private’ to ‘bucketLevel’. This simple
change should avoid users dealing with access control issues. However,
if for some reason a user needs to change the access control policy
(maybe to reduce the data exposure), from rgee v.1.2.0 all the rgee GCS
functions (<a href="https://r-spatial.github.io/rgee/reference/sf_as_ee.html">sf_as_ee</a>,
<a href="https://r-spatial.github.io/rgee/reference/local_to_gcs.html">local_to_gcs</a>,
<a href="https://r-spatial.github.io/rgee/reference/raster_as_ee.html">raster_as_ee</a>,
and <a href="https://r-spatial.github.io/rgee/reference/stars_as_ee.html">stars_as_ee</a>)
support the <code>predefinedAcl</code> argument too (Thanks to @<a href="https://github.com/jsocolar" class="external-link">jsocolar</a>).</p>
</div>
<div class="section level2">
<h2 id="error-in-earth-engine-servers-unable-to-write-to-bucket-demo_0001-permission-denied-">
<strong>ERROR in Earth Engine servers: Unable to write to bucket
demo_0001 (permission denied).</strong><a class="anchor" aria-label="anchor" href="#error-in-earth-engine-servers-unable-to-write-to-bucket-demo_0001-permission-denied-"></a>
</h2>
<p>This error arises when GEE tries to send an exported task results but
your <strong>EE USER</strong> does not have enough privileges to
write/read the bucket. <strong>Why does this occur if I have
successfully configured my SaK in my local system?</strong>. Well, the
SaK ensures a smooth connection between your local environment and GCS,
but <strong>not between GEE and GCS</strong>.</p>
<br><center>
<img src="images%2Fr5_20.png">
</center>
<p><br></p>
<p>For instance, imagine that you have access to 2 Google user accounts,
one personal and one for your work (in this example, we will call them
David and Cesar). Both accounts have access to GEE. David creates a SaK
and sends it to Cesar. As a result of this action, both Cesar and David
can work together in the same bucket, downloading and creating GCS
objects (Local &lt;-&gt; GCS). If David tries to use
<code>ee_as_raster(..., via='gcs')</code> (from GEE -&gt; GCS -&gt;
Local), GEE will recognize that the owner of the bucket is David so it
will allow the procedure (GEE -&gt; GCS) and thanks to the SaK there
will be no problem to send the information to his local environment (GCS
-&gt; Local). However, if Cesar tries to do the same, it will get an
error when passing the information from GEE -&gt; GCS because
<strong>GEE does not know that Cesar has David SaK in their local
system</strong>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/" class="external-link">rgee</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span>gcs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Define an image.</span></span>
<span><span class="va">img</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"LANDSAT/LC08/C01/T1_SR/LC08_038029_20180810"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B4"</span>, <span class="st">"B3"</span>, <span class="st">"B2"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">divide</span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define an area of interest.</span></span>
<span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="va">Geometry</span><span class="op">$</span><span class="fu">Rectangle</span><span class="op">(</span></span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">110.8</span>, <span class="fl">44.6</span>, <span class="op">-</span><span class="fl">110.6</span>, <span class="fl">44.7</span><span class="op">)</span>,</span>
<span>  proj <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>  geodesic <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">img_03</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ee_as_raster.html">ee_as_raster</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">img</span>,</span>
<span>  region <span class="op">=</span> <span class="va">geometry</span>,</span>
<span>  container <span class="op">=</span> <span class="st">"demo_0001"</span>,</span>
<span>  via <span class="op">=</span> <span class="st">"gcs"</span>,</span>
<span>  scale <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ERROR in Earth Engine servers: Unable to write to bucket demo_0001 (permission denied).</span></span></code></pre></div>
<p>This error is quite easy to fix. Just go to the bucket in your Google
Cloud Platform console.</p>
<br><center>
<img src="images%2Fr5_21.png">
</center>
<p>Click on ‘PERMISSIONS’, and click on ‘ADD’.</p>
<center>
<img src="images%2Fr5_22.png">
</center>
<p>Finally, add the Google user account of the <strong>EE USER</strong>.
<strong>Do not forget to add ‘STORAGE ADMIN’ in the role!</strong></p>
<center>
<img src="images%2Fr5_23.png">
</center>
<p><br></p>
</div>
<div class="section level2">
<h2 id="conclusion">
<strong>Conclusion</strong><a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Setting up a SaK for GCS can be quite frustrating but it is
definitely worth it!. If you are still having problems setting up your
SaK, feel free to clearly detail your problem in <a href="https://github.com/r-spatial/rgee/issues" class="external-link">rgee issues</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Cesar Aybar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
